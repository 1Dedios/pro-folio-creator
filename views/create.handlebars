{{#if portfolio}}
<h1>Edit Your Portfolio</h1>
<p>Update your portfolio information below</p>
{{else}}
<h1>Create Your Portfolio</h1>
<p>Fill out the form below to create your portfolio</p>
{{/if}}

{{#if error}}
<div class="error-container">
  <p class="error-message">{{error}}</p>
</div>
{{/if}}

{{#if portfolioJson}}
<script id="portfolioJson" type="application/json">{{{portfolioJson}}}</script>
{{/if}}

<form action="{{#if portfolio}}/portfolio/{{portfolio._id}}/edit{{else}}/create{{/if}}" method="POST" class="portfolio-form">
  <div class="form-group">
    <label for="title">Title:<span>*</span></label>
    <input type="text" id="title" name="title" value="{{#if portfolio}}{{portfolio.title}}{{else}}{{formData.title}}{{/if}}" required>
  </div>

  <div class="form-group">
    <label for="description">Description:<span>*</span></label>
    <textarea id="description" name="description" rows="3" required>{{#if portfolio}}{{portfolio.description}}{{else}}{{formData.description}}{{/if}}</textarea>
  </div>


  <h2>Sections</h2>
  <p>Add sections to your portfolio</p>

  <div id="sections-container">
    <!-- Sections will be added here dynamically -->
  </div>

  <div class="section-buttons">
    <button type="button" class="btn-secondary" onclick="addSection('education')">Add Education Section</button>
    <button type="button" class="btn-secondary" onclick="addSection('work')">Add Work Experience Section</button>
    <button type="button" class="btn-secondary" onclick="addSection('certification')">Add Certification Section</button>
    <button type="button" class="btn-secondary" onclick="addSection('project')">Add Project Section</button>
    <button type="button" class="btn-secondary" onclick="addSection('custom')">Add Custom Section</button>
  </div>

  <div class="form-group checkbox-group">
    <label for="multiPageLayout">
      <input type="checkbox" id="multiPageLayout" name="multiPageLayout" {{#if formData.multiPageLayout}}checked{{/if}} onchange="togglePageNamesSection()">
      <span>Enable Multi-page Layout</span>
    </label>
  </div>

  <div id="pageNamesSection" style="display: none;">
    <h3>Page Names</h3>
    <p>Add up to 8 page names for your multi-page portfolio</p>
    <div id="pageNames-container">
      <div class="form-group">
        <label for="pageName0">Page 1:<span>*</span></label>
        <input type="text" id="pageName0" name="pageNames[0]" value="Page 1" required>
      </div>
    </div>
    <button type="button" class="btn-secondary" id="addPageBtn" onclick="addPageName()">Add Another Page</button>
  </div>

  <div class="form-group checkbox-group">
    <label for="contactButtonEnabled">
      <input type="checkbox" id="contactButtonEnabled" name="contactButtonEnabled" {{#if portfolio}}{{#if portfolio.contactButtonEnabled}}checked{{/if}}{{else}}{{#if formData.contactButtonEnabled}}checked{{/if}}{{/if}}>
      <span>Enable "Contact Me" button</span>
    </label>
  </div>

  <h2>Theme</h2>
  <p>Select a theme for your portfolio or create a new one</p>

  <div class="theme-selection">
    <div class="form-group">
      <label for="themeSelector">Select Theme:</label>
      <select id="themeSelector" name="themeId">
        <option value="">-- Select a theme --</option>
        <!-- Themes will be loaded via JavaScript -->
      </select>
    </div>

    <div class="theme-preview">
      <div class="theme-preview-header">Theme Preview</div>
      <div class="theme-preview-content" id="themePreview">
        <div class="preview-background">
          <div class="preview-section">
            <div class="preview-text">Sample Text</div>
          </div>
        </div>
      </div>
    </div>

    <button type="button" class="btn-secondary" id="createThemeBtn" onclick="toggleCreateThemeForm()">Create New Theme</button>
  </div>

  <div id="createThemeForm" style="display: none;">
    <h3>Create New Theme</h3>
    <div class="form-group">
      <label for="themeName">Theme Name:</label>
      <input type="text" id="themeName" name="themeName" placeholder="My Custom Theme">
    </div>

    <div class="color-pickers">
      <div class="color-picker-group">
        <label for="backgroundColor">Background Color:</label>
        <div id="backgroundColorPicker" class="color-picker"></div>
        <input type="text" id="backgroundColor" name="backgroundColor" value="#F9FAFB" readonly>
      </div>

      <div class="color-picker-group">
        <label for="sectionColor">Section Color:</label>
        <div id="sectionColorPicker" class="color-picker"></div>
        <input type="text" id="sectionColor" name="sectionColor" value="#FFFFFF" readonly>
      </div>

      <div class="color-picker-group">
        <label for="textColor">Text Color:</label>
        <div id="textColorPicker" class="color-picker"></div>
        <input type="text" id="textColor" name="textColor" value="#1F2937" readonly>
      </div>
    </div>

    <div class="theme-form-buttons">
      <button type="button" class="btn-secondary" onclick="saveNewTheme()">Save Theme</button>
      <button type="button" class="btn-secondary" onclick="toggleCreateThemeForm()">Cancel</button>
    </div>
  </div>

  <button type="submit" class="btn-primary">{{#if portfolio}}Update Portfolio{{else}}Create Portfolio{{/if}}</button>
</form>

<!-- Templates for different section types -->
<template id="education-template">
  <div class="section education-section">
    <div class="section-header">
      <h3>Education</h3>
      <div class="section-controls">
        <div class="page-selector" style="display: none;">
          <select id="pageSelector{index}" name="sections[{index}][pageSelector]">
            <!-- Options will be added dynamically -->
          </select>
        </div>
        <button type="button" class="btn-arrow move-up" onclick="moveSection('section-{index}', 'up')" title="Move Up">↑</button>
        <button type="button" class="btn-arrow move-down" onclick="moveSection('section-{index}', 'down')" title="Move Down">↓</button>
        <button type="button" class="btn-delete delete-section" onclick="deleteSection('section-{index}')">Delete Section</button>
      </div>
    </div>
    <div class="section-items">
      <div class="section-item">
        <div class="form-group">
          <label for="institution">Institution:<span>*</span></label>
          <input type="text" name="sections[{index}][items][0][institution]" required>
        </div>
        <div class="form-group">
          <label for="degree">Degree:<span>*</span></label>
          <input type="text" name="sections[{index}][items][0][degree]" required>
        </div>
        <div class="form-group">
          <label for="startDate">Start Date:</label>
          <input type="date" name="sections[{index}][items][0][startDate]">
        </div>
        <div class="form-group">
          <label for="endDate">End Date (leave blank if current):</label>
          <input type="date" name="sections[{index}][items][0][endDate]">
        </div>
        <div class="form-group">
          <label for="location">Location:</label>
          <input type="text" name="sections[{index}][items][0][location]">
        </div>
        <div class="form-group">
          <label for="description">Description:</label>
          <textarea name="sections[{index}][items][0][description]" rows="3"></textarea>
        </div>
      </div>
    </div>
    <button type="button" class="btn-secondary add-entry-btn" onclick="addEntry('section-{index}')">Add Another Education Entry</button>
    <input type="hidden" name="sections[{index}][type]" value="education">
  </div>
</template>

<template id="education-item-template">
  <div class="section-item">
    <hr>
    <div class="item-header">
      <div class="item-controls">
        <button type="button" class="btn-arrow move-up" onclick="moveItem(this, 'up')" title="Move Up">↑</button>
        <button type="button" class="btn-arrow move-down" onclick="moveItem(this, 'down')" title="Move Down">↓</button>
        <button type="button" class="btn-delete delete-item" onclick="deleteItem(this)" style="display: none;">Delete Entry</button>
      </div>
    </div>
    <div class="form-group">
      <label for="institution">Institution:<span>*</span></label>
      <input type="text" name="sections[{index}][items][{itemIndex}][institution]" required>
    </div>
    <div class="form-group">
      <label for="degree">Degree:<span>*</span></label>
      <input type="text" name="sections[{index}][items][{itemIndex}][degree]" required>
    </div>
    <div class="form-group">
      <label for="startDate">Start Date:</label>
      <input type="date" name="sections[{index}][items][{itemIndex}][startDate]">
    </div>
    <div class="form-group">
      <label for="endDate">End Date (leave blank if current):</label>
      <input type="date" name="sections[{index}][items][{itemIndex}][endDate]">
    </div>
    <div class="form-group">
      <label for="location">Location:</label>
      <input type="text" name="sections[{index}][items][{itemIndex}][location]">
    </div>
    <div class="form-group">
      <label for="description">Description:</label>
      <textarea name="sections[{index}][items][{itemIndex}][description]" rows="3"></textarea>
    </div>
  </div>
</template>

<template id="work-template">
  <div class="section work-section">
    <div class="section-header">
      <h3>Work Experience</h3>
      <div class="section-controls">
        <div class="page-selector" style="display: none;">
          <select id="pageSelector{index}" name="sections[{index}][pageSelector]">
            <!-- Options will be added dynamically -->
          </select>
        </div>
        <button type="button" class="btn-arrow move-up" onclick="moveSection('section-{index}', 'up')" title="Move Up">↑</button>
        <button type="button" class="btn-arrow move-down" onclick="moveSection('section-{index}', 'down')" title="Move Down">↓</button>
        <button type="button" class="btn-delete delete-section" onclick="deleteSection('section-{index}')">Delete Section</button>
      </div>
    </div>
    <div class="section-items">
      <div class="section-item">
        <div class="form-group">
          <label for="company">Company:<span>*</span></label>
          <input type="text" name="sections[{index}][items][0][company]" required>
        </div>
        <div class="form-group">
          <label for="role">Role:<span>*</span></label>
          <input type="text" name="sections[{index}][items][0][role]" required>
        </div>
        <div class="form-group">
          <label for="startDate">Start Date:</label>
          <input type="date" name="sections[{index}][items][0][startDate]">
        </div>
        <div class="form-group">
          <label for="endDate">End Date (leave blank if current):</label>
          <input type="date" name="sections[{index}][items][0][endDate]">
        </div>
        <div class="form-group">
          <label for="location">Location:</label>
          <input type="text" name="sections[{index}][items][0][location]">
        </div>
        <div class="form-group">
          <label for="description">Description:</label>
          <textarea name="sections[{index}][items][0][description]" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="achievements">Achievements (one per line):</label>
          <textarea name="sections[{index}][items][0][achievements]" rows="3"></textarea>
        </div>
      </div>
    </div>
    <button type="button" class="btn-secondary add-entry-btn" onclick="addEntry('section-{index}')">Add Another Work Experience Entry</button>
    <input type="hidden" name="sections[{index}][type]" value="work">
  </div>
</template>

<template id="work-item-template">
  <div class="section-item">
    <hr>
    <div class="item-header">
      <div class="item-controls">
        <button type="button" class="btn-arrow move-up" onclick="moveItem(this, 'up')" title="Move Up">↑</button>
        <button type="button" class="btn-arrow move-down" onclick="moveItem(this, 'down')" title="Move Down">↓</button>
        <button type="button" class="btn-delete delete-item" onclick="deleteItem(this)" style="display: none;">Delete Entry</button>
      </div>
    </div>
    <div class="form-group">
      <label for="company">Company:<span>*</span></label>
      <input type="text" name="sections[{index}][items][{itemIndex}][company]" required>
    </div>
    <div class="form-group">
      <label for="role">Role:<span>*</span></label>
      <input type="text" name="sections[{index}][items][{itemIndex}][role]" required>
    </div>
    <div class="form-group">
      <label for="startDate">Start Date:</label>
      <input type="date" name="sections[{index}][items][{itemIndex}][startDate]">
    </div>
    <div class="form-group">
      <label for="endDate">End Date (leave blank if current):</label>
      <input type="date" name="sections[{index}][items][{itemIndex}][endDate]">
    </div>
    <div class="form-group">
      <label for="location">Location:</label>
      <input type="text" name="sections[{index}][items][{itemIndex}][location]">
    </div>
    <div class="form-group">
      <label for="description">Description:</label>
      <textarea name="sections[{index}][items][{itemIndex}][description]" rows="3"></textarea>
    </div>
    <div class="form-group">
      <label for="achievements">Achievements (one per line):</label>
      <textarea name="sections[{index}][items][{itemIndex}][achievements]" rows="3"></textarea>
    </div>
  </div>
</template>

<template id="certification-template">
  <div class="section certification-section">
    <div class="section-header">
      <h3>Certification</h3>
      <div class="section-controls">
        <div class="page-selector" style="display: none;">
          <select id="pageSelector{index}" name="sections[{index}][pageSelector]">
            <!-- Options will be added dynamically -->
          </select>
        </div>
        <button type="button" class="btn-arrow move-up" onclick="moveSection('section-{index}', 'up')" title="Move Up">↑</button>
        <button type="button" class="btn-arrow move-down" onclick="moveSection('section-{index}', 'down')" title="Move Down">↓</button>
        <button type="button" class="btn-delete delete-section" onclick="deleteSection('section-{index}')">Delete Section</button>
      </div>
    </div>
    <div class="section-items">
      <div class="section-item">
        <div class="form-group">
          <label for="title">Title:<span>*</span></label>
          <input type="text" name="sections[{index}][items][0][title]" required>
        </div>
        <div class="form-group">
          <label for="issuer">Issuer:<span>*</span></label>
          <input type="text" name="sections[{index}][items][0][issuer]" required>
        </div>
        <div class="form-group">
          <label for="issueDate">Issue Date:</label>
          <input type="date" name="sections[{index}][items][0][issueDate]">
        </div>
        <div class="form-group">
          <label for="expirationDate">Expiration Date (if applicable):</label>
          <input type="date" name="sections[{index}][items][0][expirationDate]">
        </div>
        <div class="form-group">
          <label for="description">Description:</label>
          <textarea name="sections[{index}][items][0][description]" rows="3"></textarea>
        </div>
      </div>
    </div>
    <button type="button" class="btn-secondary add-entry-btn" onclick="addEntry('section-{index}')">Add Another Certification Entry</button>
    <input type="hidden" name="sections[{index}][type]" value="certification">
  </div>
</template>

<template id="certification-item-template">
  <div class="section-item">
    <hr>
    <div class="item-header">
      <div class="item-controls">
        <button type="button" class="btn-arrow move-up" onclick="moveItem(this, 'up')" title="Move Up">↑</button>
        <button type="button" class="btn-arrow move-down" onclick="moveItem(this, 'down')" title="Move Down">↓</button>
        <button type="button" class="btn-delete delete-item" onclick="deleteItem(this)" style="display: none;">Delete Entry</button>
      </div>
    </div>
    <div class="form-group">
      <label for="title">Title:<span>*</span></label>
      <input type="text" name="sections[{index}][items][{itemIndex}][title]" required>
    </div>
    <div class="form-group">
      <label for="issuer">Issuer:<span>*</span></label>
      <input type="text" name="sections[{index}][items][{itemIndex}][issuer]" required>
    </div>
    <div class="form-group">
      <label for="issueDate">Issue Date:</label>
      <input type="date" name="sections[{index}][items][{itemIndex}][issueDate]">
    </div>
    <div class="form-group">
      <label for="expirationDate">Expiration Date (if applicable):</label>
      <input type="date" name="sections[{index}][items][{itemIndex}][expirationDate]">
    </div>
    <div class="form-group">
      <label for="description">Description:</label>
      <textarea name="sections[{index}][items][{itemIndex}][description]" rows="3"></textarea>
    </div>
  </div>
</template>

<template id="project-template">
  <div class="section project-section">
    <div class="section-header">
      <h3>Project</h3>
      <div class="section-controls">
        <div class="page-selector" style="display: none;">
          <select id="pageSelector{index}" name="sections[{index}][pageSelector]">
            <!-- Options will be added dynamically -->
          </select>
        </div>
        <button type="button" class="btn-arrow move-up" onclick="moveSection('section-{index}', 'up')" title="Move Up">↑</button>
        <button type="button" class="btn-arrow move-down" onclick="moveSection('section-{index}', 'down')" title="Move Down">↓</button>
        <button type="button" class="btn-delete delete-section" onclick="deleteSection('section-{index}')">Delete Section</button>
      </div>
    </div>
    <div class="section-items">
      <div class="section-item">
        <div class="form-group">
          <label for="title">Title:<span>*</span></label>
          <input type="text" name="sections[{index}][items][0][title]" required>
        </div>
        <div class="form-group">
          <label for="description">Description:</label>
          <textarea name="sections[{index}][items][0][description]" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="technologies">Technologies (comma separated):</label>
          <input type="text" name="sections[{index}][items][0][technologies]">
        </div>
        <div class="form-group">
          <label for="startDate">Start Date:</label>
          <input type="date" name="sections[{index}][items][0][startDate]">
        </div>
        <div class="form-group">
          <label for="endDate">End Date (leave blank if current):</label>
          <input type="date" name="sections[{index}][items][0][endDate]">
        </div>
        <div class="form-group">
          <label for="githubRepo">GitHub Repository URL:</label>
          <input type="url" name="sections[{index}][items][0][githubRepo]">
        </div>
      </div>
    </div>
    <button type="button" class="btn-secondary add-entry-btn" onclick="addEntry('section-{index}')">Add Another Project Entry</button>
    <input type="hidden" name="sections[{index}][type]" value="project">
  </div>
</template>

<template id="project-item-template">
  <div class="section-item">
    <hr>
    <div class="item-header">
      <div class="item-controls">
        <button type="button" class="btn-arrow move-up" onclick="moveItem(this, 'up')" title="Move Up">↑</button>
        <button type="button" class="btn-arrow move-down" onclick="moveItem(this, 'down')" title="Move Down">↓</button>
        <button type="button" class="btn-delete delete-item" onclick="deleteItem(this)" style="display: none;">Delete Entry</button>
      </div>
    </div>
    <div class="form-group">
      <label for="title">Title:<span>*</span></label>
      <input type="text" name="sections[{index}][items][{itemIndex}][title]" required>
    </div>
    <div class="form-group">
      <label for="description">Description:</label>
      <textarea name="sections[{index}][items][{itemIndex}][description]" rows="3"></textarea>
    </div>
    <div class="form-group">
      <label for="technologies">Technologies (comma separated):</label>
      <input type="text" name="sections[{index}][items][{itemIndex}][technologies]">
    </div>
    <div class="form-group">
      <label for="startDate">Start Date:</label>
      <input type="date" name="sections[{index}][items][{itemIndex}][startDate]">
    </div>
    <div class="form-group">
      <label for="endDate">End Date (leave blank if current):</label>
      <input type="date" name="sections[{index}][items][{itemIndex}][endDate]">
    </div>
    <div class="form-group">
      <label for="githubRepo">GitHub Repository URL:</label>
      <input type="url" name="sections[{index}][items][{itemIndex}][githubRepo]">
    </div>
  </div>
</template>

<template id="custom-template">
  <div class="section custom-section">
    <div class="section-header">
      <h3>Custom Section</h3>
      <div class="section-controls">
        <div class="page-selector" style="display: none;">
          <select id="pageSelector{index}" name="sections[{index}][pageSelector]">
            <!-- Options will be added dynamically -->
          </select>
        </div>
        <button type="button" class="btn-arrow move-up" onclick="moveSection('section-{index}', 'up')" title="Move Up">↑</button>
        <button type="button" class="btn-arrow move-down" onclick="moveSection('section-{index}', 'down')" title="Move Down">↓</button>
        <button type="button" class="btn-delete delete-section" onclick="deleteSection('section-{index}')">Delete Section</button>
      </div>
    </div>
    <div class="section-item">
      <div class="form-group">
        <label for="title">Title:<span>*</span></label>
        <input type="text" name="sections[{index}][items][0][title]" required>
      </div>
      <div class="form-group">
        <label for="content">Content:</label>
        <div id="editor-{index}" class="quill-editor"></div>
        <input type="hidden" name="sections[{index}][items][0][content]" id="content-{index}">
      </div>
      <input type="hidden" name="sections[{index}][type]" value="custom">
    </div>
  </div>
</template>

<!-- Include Quill.js for rich text editing -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
  let sectionIndex = 0;
  const quillEditors = [];

  // Scroll to top if there's an error and recreate sections from form data
  window.onload = function() {
    if (document.querySelector('.error-container')) {
      window.scrollTo(0, 0);
    }

    // Add event listener to the initial "Home" page input to update page selectors when the value changes
    const homePageInput = document.getElementById('pageName0');
    if (homePageInput) {
      homePageInput.addEventListener('input', updatePageSelectors);
    }

    // Check if we're in edit mode with portfolio data
    const portfolioJson = "{{portfolioJson}}";
    if (portfolioJson) {
      try {
        // console.log("[DEBUG_LOG] Starting to process portfolio JSON data");
        // console.log("[DEBUG_LOG] Raw portfolioJson:", portfolioJson);
        const portfolio = JSON.parse(portfolioJson.replace(/&quot;/g, '"'));
                // No need to decode HTML entities in custom section content
                // The content will be used directly by the Quill editor
        // console.log("[DEBUG_LOG] Parsed portfolio object:", portfolio);
        // console.log("[DEBUG_LOG] Portfolio title:", portfolio.title);
        // console.log("[DEBUG_LOG] Portfolio description:", portfolio.description);
        // console.log("[DEBUG_LOG] Portfolio layout:", portfolio.layout);

        if (portfolio && portfolio.sections) {
          // console.log("[DEBUG_LOG] Portfolio has sections array with length:", portfolio.sections.length);
          // Log each section type and its items
          portfolio.sections.forEach((section, i) => {
            // console.log(`[DEBUG_LOG] Processing section ${i}, type: ${section.type}, id: ${section._id}`);
            // console.log(`[DEBUG_LOG] Section ${i} has ${section.items ? section.items.length : 0} items`);
            if (section.items && section.items.length > 0) {
              section.items.forEach((item, j) => {
                // console.log(`[DEBUG_LOG] Section ${i}, Item ${j} data:`, JSON.stringify(item));
              });
            }
          });

          // Log layout information
          if (portfolio.layout) {
            // console.log(`[DEBUG_LOG] Layout singlePage: ${portfolio.layout.singlePage}`);
            if (portfolio.layout.pages) {
              // console.log(`[DEBUG_LOG] Layout has ${portfolio.layout.pages.length} pages`);
              portfolio.layout.pages.forEach((page, i) => {
                // console.log(`[DEBUG_LOG] Page ${i}: title=${page.title}, sectionIds=${page.sectionIds ? page.sectionIds.map(id => id.toString()).join(', ') : 'none'}`);
              });
            }
          }

          // Set multi-page layout checkbox if needed
          if (portfolio.layout && !portfolio.layout.singlePage) {
            // console.log("[DEBUG_LOG] Setting multi-page layout checkbox");
            // console.log("[DEBUG_LOG] Layout object:", JSON.stringify(portfolio.layout));

            // Check if the multiPageLayout checkbox exists
            const multiPageLayoutCheckbox = document.getElementById('multiPageLayout');
            if (multiPageLayoutCheckbox) {
              // console.log("[DEBUG_LOG] Found multiPageLayout checkbox, setting checked=true");
              multiPageLayoutCheckbox.checked = true;
              togglePageNamesSection();
            } else {
              console.error("[DEBUG_LOG] ERROR: multiPageLayout checkbox not found in the DOM");
            }

            // Add page names
            if (portfolio.layout.pages && portfolio.layout.pages.length > 0) {
              // console.log(`[DEBUG_LOG] Layout has ${portfolio.layout.pages.length} pages`);

              // First page is already there (Home)
              const pageName0Input = document.getElementById('pageName0');
              if (pageName0Input) {
                pageName0Input.value = portfolio.layout.pages[0].title;
                // console.log(`[DEBUG_LOG] Set page 0 name to: ${portfolio.layout.pages[0].title}`);
              } else {
                console.error("[DEBUG_LOG] ERROR: pageName0 input not found in the DOM");
              }

              // Add additional pages
              for (let i = 1; i < portfolio.layout.pages.length; i++) {
                // console.log(`[DEBUG_LOG] Adding page ${i}`);
                addPageName();

                const pageNameInput = document.getElementById(`pageName${i}`);
                if (pageNameInput) {
                  pageNameInput.value = portfolio.layout.pages[i].title;
                  // console.log(`[DEBUG_LOG] Set page ${i} name to: ${portfolio.layout.pages[i].title}`);
                } else {
                  console.error(`[DEBUG_LOG] ERROR: pageName${i} input not found in the DOM`);
                }
              }
            }
          } else {
            // console.log("[DEBUG_LOG] Not setting multi-page layout checkbox because layout.singlePage is true or layout is undefined");
            // console.log("[DEBUG_LOG] Layout value:", JSON.stringify(portfolio.layout));
          }

          // First, add all sections to the DOM
          // console.log("[DEBUG_LOG] First phase: Adding all sections to the DOM");
          // console.log("[DEBUG_LOG] Number of sections:", portfolio.sections.length);

          // Check if sections array is valid
          if (!Array.isArray(portfolio.sections)) {
            console.error("[DEBUG_LOG] ERROR: portfolio.sections is not an array:", portfolio.sections);
            return;
          }

          const sectionsData = [];

          portfolio.sections.forEach((section, index) => {
            // console.log(`[DEBUG_LOG] Processing section ${index}:`, JSON.stringify(section));

            if (!section) {
              console.error(`[DEBUG_LOG] ERROR: Section ${index} is null or undefined`);
              return;
            }

            if (!section.type) {
              console.error(`[DEBUG_LOG] ERROR: Section ${index} has no type:`, JSON.stringify(section));
              return;
            }

            // console.log(`[DEBUG_LOG] Adding section of type: ${section.type}, id: ${section._id}`);

            try {
              addSection(section.type);
              // console.log(`[DEBUG_LOG] Successfully added section of type: ${section.type}`);

              // Get the section container that was just added
              const sectionContainer = document.getElementById(`section-${sectionIndex - 1}`);

              if (!sectionContainer) {
                console.error(`[DEBUG_LOG] ERROR: Section container with id section-${sectionIndex - 1} not found in the DOM`);
                return;
              }

              // console.log(`[DEBUG_LOG] Created section container with id: section-${sectionIndex - 1}`);

              // Store the section ID for later use if it exists
              if (section._id) {
                // For copied example portfolios, we need to use the new section ID from the sectionIdMap
                const sectionId = section._id.toString();

                // Add a hidden input with the section ID
                const sectionIdInput = document.createElement('input');
                sectionIdInput.type = 'hidden';
                sectionIdInput.name = `sections[${sectionIndex - 1}][_id]`;
                sectionIdInput.value = sectionId;
                sectionContainer.appendChild(sectionIdInput);

                sectionContainer.dataset.sectionId = sectionId;
                // console.log(`[DEBUG_LOG] Set section container dataset.sectionId to: ${sectionId}`);
              } else {
                // console.log(`[DEBUG_LOG] Section has no _id, skipping dataset assignment`);
              }

              // Store section data for later processing
              sectionsData.push({
                section: section,
                sectionContainer: sectionContainer,
                sectionIndex: sectionIndex - 1
              });
              // console.log(`[DEBUG_LOG] Stored section data for later processing, sectionIndex: ${sectionIndex - 1}`);

              // If this section has items, add them
              if (section.items && Array.isArray(section.items)) {
                // console.log(`[DEBUG_LOG] Section has ${section.items.length} items`);

                // The first item is already added by addSection, so we start from the second item
                for (let i = 1; i < section.items.length; i++) {
                  // console.log(`[DEBUG_LOG] Adding additional item ${i} to section-${sectionIndex - 1}`);
                  try {
                    addEntry(`section-${sectionIndex - 1}`);
                    // console.log(`[DEBUG_LOG] Successfully added item ${i} to section-${sectionIndex - 1}`);
                  } catch (error) {
                    console.error(`[DEBUG_LOG] ERROR: Failed to add item ${i} to section-${sectionIndex - 1}:`, error);
                  }
                }
              } else {
                // console.log(`[DEBUG_LOG] Section has no items or items is not an array:`, section.items);
              }
            } catch (error) {
              console.error(`[DEBUG_LOG] ERROR: Failed to add section of type ${section.type}:`, error);
            }
          });

          // After all sections are added to the DOM, populate their values
          // console.log("[DEBUG_LOG] Second phase: Populating all sections with values");
          // console.log("[DEBUG_LOG] Number of sections to populate:", sectionsData.length);

          setTimeout(() => {
            sectionsData.forEach(({ section, sectionContainer, sectionIndex }, dataIndex) => {
              // console.log(`[DEBUG_LOG] Populating section ${dataIndex} of type: ${section.type}, id: ${section._id}`);

              if (!sectionContainer) {
                console.error(`[DEBUG_LOG] ERROR: Section container is null or undefined for section ${dataIndex}`);
                return;
              }

              // console.log(`[DEBUG_LOG] Section container exists with id: ${sectionContainer.id}`);

              // If this section has items, populate them
              if (section.items && Array.isArray(section.items)) {
                // console.log(`[DEBUG_LOG] Section has ${section.items.length} items to populate`);

                // For custom sections, the structure is different - there's no .section-items container
                let itemsContainer;
                if (section.type === 'custom') {
                  // For custom sections, use the section container itself to find .section-item
                  itemsContainer = sectionContainer;
                  // console.log(`[DEBUG_LOG] Using section container as items container for custom section`);
                } else {
                  // For other section types, find the .section-items container
                  itemsContainer = sectionContainer.querySelector('.section-items');
                  if (!itemsContainer) {
                    console.error(`[DEBUG_LOG] ERROR: Items container not found for section ${section.type}`);
                    console.error(`[DEBUG_LOG] Section container id: ${sectionContainer.id}`);
                    console.error(`[DEBUG_LOG] Section container HTML:`, sectionContainer.outerHTML);
                    return;
                  }
                  // console.log(`[DEBUG_LOG] Found items container for section ${section.type}`);
                }

                const itemElements = itemsContainer.querySelectorAll('.section-item');
                // console.log(`[DEBUG_LOG] Found ${itemElements.length} item elements for section ${section.type}`);

                if (itemElements.length === 0) {
                  console.error(`[DEBUG_LOG] ERROR: No item elements found for section ${section.type}`);
                  // console.log(`[DEBUG_LOG] Items container HTML:`, itemsContainer.outerHTML);
                }

                if (section.items.length > itemElements.length) {
                  console.warn(`[DEBUG_LOG] WARNING: Section has ${section.items.length} items but only ${itemElements.length} item elements were found`);
                }

                section.items.forEach((item, itemIndex) => {
                  // console.log(`[DEBUG_LOG] Processing section ${section.type}, Item ${itemIndex}`);

                  if (!item) {
                    console.error(`[DEBUG_LOG] ERROR: Item ${itemIndex} is null or undefined`);
                    return;
                  }

                  // console.log(`[DEBUG_LOG] Item ${itemIndex} data:`, JSON.stringify(item));

                  if (itemIndex < itemElements.length) {
                    const itemElement = itemElements[itemIndex];

                    if (!itemElement) {
                      console.error(`[DEBUG_LOG] ERROR: Item element ${itemIndex} is null or undefined`);
                      return;
                    }

                    // console.log(`[DEBUG_LOG] Found item element for ${section.type}, Item ${itemIndex}`);
                    // console.log(`[DEBUG_LOG] Found item element for ${section.type}, Item ${itemIndex}:`, itemElement);

                    // Store the item ID for later use if it exists
                    if (item._id) {
                      itemElement.dataset.itemId = item._id.toString();
                      // console.log(`[DEBUG_LOG] Set item ID: ${item._id.toString()} on element`);
                    } else {
                      // console.log(`[DEBUG_LOG] Item has no _id, skipping dataset assignment`);
                    }

                    // Populate all inputs and textareas in this item
                    const inputs = itemElement.querySelectorAll('input:not([type="hidden"]), textarea');
                    // console.log(`[DEBUG_LOG] Found ${inputs.length} inputs/textareas for ${section.type}, Item ${itemIndex}`);

                    if (inputs.length === 0) {
                      // console.error(`[DEBUG_LOG] ERROR: No input elements found for section ${section.type}, item ${itemIndex}`);
                      // console.log(`[DEBUG_LOG] Item element HTML:`, itemElement.outerHTML);
                    }

                    inputs.forEach(input => {
                      const name = input.getAttribute('name');
                      // console.log(`[DEBUG_LOG] Processing input: name=${name}, type=${input.type}, tagName=${input.tagName}`);

                      if (!name) {
                        // console.warn(`[DEBUG_LOG] WARNING: Input has no name attribute:`, input);
                        return;
                      }

                      try {
                        // Extract the field name from the name attribute
                        // The name format is like: sections[{index}][items][{itemIndex}][fieldName]
                        // We need to extract the last part (fieldName)
                        const matches = name.match(/\[([^\]]+)\]$/);
                        const fieldName = matches ? matches[1] : '';
                        // console.log(`[DEBUG_LOG] Extracted field name: ${fieldName}, value in item: ${JSON.stringify(item[fieldName])}`);

                        if (item[fieldName] !== undefined) {
                          // console.log(`[DEBUG_LOG] Setting value for field ${fieldName} to ${JSON.stringify(item[fieldName])}`);

                          // Handle special cases
                          if (fieldName === 'achievements' && Array.isArray(item[fieldName])) {
                            const value = item[fieldName].join('\n');
                            // console.log(`[DEBUG_LOG] Setting achievements value: ${value}`);
                            input.value = value;
                            // console.log(`[DEBUG_LOG] After setting, achievements value is: ${input.value}`);
                          } else if (fieldName === 'technologies' && Array.isArray(item[fieldName])) {
                            const value = item[fieldName].join(', ');
                            // console.log(`[DEBUG_LOG] Setting technologies value: ${value}`);
                            input.value = value;
                            // console.log(`[DEBUG_LOG] After setting, technologies value is: ${input.value}`);
                          } else if (fieldName.includes('Date') && item[fieldName]) {
                            // Format date as YYYY-MM-DD for input[type="date"]
                            const date = new Date(item[fieldName]);
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const formattedDate = `${year}-${month}-${day}`;
                            // console.log(`[DEBUG_LOG] Setting date value: ${formattedDate}`);
                            input.value = formattedDate;
                            // console.log(`[DEBUG_LOG] After setting, date value is: ${input.value}`);
                          } else if (input.tagName === 'TEXTAREA') {
                            // console.log(`[DEBUG_LOG] Setting textarea value using multiple methods`);
                            // Try multiple approaches to set textarea value
                            // console.log(`[DEBUG_LOG] Before setting: defaultValue=${input.defaultValue}, value=${input.value}, innerHTML=${input.innerHTML}`);

                            input.defaultValue = item[fieldName];
                            // console.log(`[DEBUG_LOG] After setting defaultValue: ${input.defaultValue}`);

                            input.value = item[fieldName];
                            // console.log(`[DEBUG_LOG] After setting value: ${input.value}`);

                            input.innerHTML = item[fieldName];
                            // console.log(`[DEBUG_LOG] After setting innerHTML: ${input.innerHTML}`);

                            input.innerText = item[fieldName];
                            // console.log(`[DEBUG_LOG] After setting innerText: ${input.innerText}`);

                            // Force a change event to ensure the value is set
                            const event = new Event('change', { bubbles: true });
                            input.dispatchEvent(event);
                            // console.log(`[DEBUG_LOG] Dispatched change event`);

                            // Final check
                            // console.log(`[DEBUG_LOG] Final textarea state: defaultValue=${input.defaultValue}, value=${input.value}, innerHTML=${input.innerHTML}`);
                          } else {
                            // console.log(`[DEBUG_LOG] Setting regular input value: ${item[fieldName]}`);
                            input.value = item[fieldName];
                            // console.log(`[DEBUG_LOG] After setting, input value is: ${input.value}`);
                          }

                          // Verify the value was set correctly
                          if (input.value !== item[fieldName] && 
                              !(Array.isArray(item[fieldName])) && 
                              !(fieldName.includes('Date'))) {
                            // console.warn(`[DEBUG_LOG] WARNING: Value mismatch after setting. Expected: ${item[fieldName]}, Actual: ${input.value}`);
                          }
                        } else {
                          // console.log(`[DEBUG_LOG] Field ${fieldName} not found in item data`);
                        }
                      } catch (error) {
                        // console.error(`[DEBUG_LOG] ERROR processing field: ${error.message}`, error);
                      }
                    });
                  } else {
                    // console.error(`[DEBUG_LOG] ERROR: Item index ${itemIndex} is out of bounds (only ${itemElements.length} elements available)`);
                  }
                });
              }

              // If this is a custom section, set the content value but don't initialize Quill yet
              // The Quill editor will be initialized by the addSection function
              if (section.type === 'custom' && section.items && section.items[0] && section.items[0].content) {
                const contentId = `content-${sectionIndex}`;
                const contentInput = document.getElementById(contentId);
                if (contentInput) {
                  contentInput.value = section.items[0].content;

                  // Set the content after ensuring the editor is initialized
                  // This will be done after all sections are added to the DOM
                  setTimeout(() => {
                    if (quillEditors[sectionIndex]) {
                      // Use clipboard.dangerouslyPasteHTML directly with the content
                      // No need for temporary div which causes HTML tags to be displayed as text
                      quillEditors[sectionIndex].clipboard.dangerouslyPasteHTML(0, section.items[0].content);
                    } else {
                      // console.log(`[DEBUG_LOG] Quill editor not found for section ${sectionIndex}, trying again in 500ms`);
                      // Try again after a longer delay if the editor is not initialized yet
                      setTimeout(() => {
                        if (quillEditors[sectionIndex]) {
                          // Use content directly without temporary div
                          quillEditors[sectionIndex].clipboard.dangerouslyPasteHTML(0, section.items[0].content);
                          // console.log(`[DEBUG_LOG] Successfully set content for section ${sectionIndex} on second attempt`);
                        } else {
                          // console.error(`[DEBUG_LOG] ERROR: Quill editor still not found for section ${sectionIndex} after second attempt, trying one more time`);
                          // Try one more time with an even longer delay
                          setTimeout(() => {
                            if (quillEditors[sectionIndex]) {
                              // Use content directly without temporary div
                              quillEditors[sectionIndex].clipboard.dangerouslyPasteHTML(0, section.items[0].content);
                              // console.log(`[DEBUG_LOG] Successfully set content for section ${sectionIndex} on third attempt`);
                            } else {
                              // console.error(`[DEBUG_LOG] ERROR: Quill editor still not found for section ${sectionIndex} after third attempt. Giving up.`);
                            }
                          }, 1000);
                        }
                      }, 500);
                    }
                  }, 500); // Delay to ensure editor is initialized
                }
              }
            });
          }, 300); // Increased delay to ensure all DOM elements are fully rendered

          // If we're in a multi-page layout, set the page selectors for each section
          if (portfolio.layout && !portfolio.layout.singlePage && portfolio.layout.pages) {
            portfolio.layout.pages.forEach((page, pageIndex) => {
              if (page.sectionIds && Array.isArray(page.sectionIds)) {
                page.sectionIds.forEach(sectionId => {
                  // Find the section with this ID
                  const sectionContainer = document.querySelector(`[data-section-id="${sectionId}"]`);
                  if (sectionContainer) {
                    const pageSelector = sectionContainer.querySelector('.page-selector select');
                    if (pageSelector) {
                      pageSelector.value = pageIndex;
                    }
                  }
                });
              }
            });
          }
        }
      } catch (e) {
        // console.error("Error parsing portfolio data:", e);
      }
    } 
    // If no portfolio data, try to recreate from form data (for error cases)
    else {
      const formDataJson = "{{formDataJson}}";
      if (formDataJson) {
        try {
          const formData = JSON.parse(formDataJson.replace(/&quot;/g, '"'));
                    // No need to decode HTML entities in custom section content
                    // The content will be used directly by the Quill editor
          if (formData && formData.sections) {
            const sectionsData = Array.isArray(formData.sections) ? formData.sections : [formData.sections];

            // Add each section
            sectionsData.forEach(section => {
              if (section.type) {
                addSection(section.type);

                // Get the section container that was just added
                const sectionContainer = document.getElementById(`section-${sectionIndex - 1}`);

                // If this section has items, add them
                if (section.items && Array.isArray(section.items)) {
                  // The first item is already added by addSection, so we start from the second item
                  for (let i = 1; i < section.items.length; i++) {
                    addEntry(`section-${sectionIndex - 1}`);
                  }

                  // Now populate all items with their values
                  // Add a small delay to ensure the DOM is fully updated
                  // console.log(`[DEBUG_LOG] Setting timeout to populate items for form data section ${section.type}`);
                  setTimeout(() => {
                    // console.log(`[DEBUG_LOG] Timeout fired for form data, starting to populate items for section ${section.type}`);

                    // For custom sections, the structure is different - there's no .section-items container
                    let itemsContainer;
                    if (section.type === 'custom') {
                      // For custom sections, use the section container itself to find .section-item
                      itemsContainer = sectionContainer;
                      console.log(`[DEBUG_LOG] Using section container as items container for form data custom section`);
                    } else {
                      // For other section types, find the .section-items container
                      itemsContainer = sectionContainer.querySelector('.section-items');
                      if (!itemsContainer) {
                        console.error(`[DEBUG_LOG] ERROR: Items container not found for form data section ${section.type}`);
                        console.error(`[DEBUG_LOG] Form data section container id: ${sectionContainer.id}`);
                        console.error(`[DEBUG_LOG] Form data section container HTML:`, sectionContainer.outerHTML);
                        return;
                      }
                      // console.log(`[DEBUG_LOG] Found items container for form data section ${section.type}`);
                    }

                    const itemElements = itemsContainer.querySelectorAll('.section-item');
                    // console.log(`[DEBUG_LOG] Found ${itemElements.length} item elements for form data section ${section.type}`);

                    if (itemElements.length === 0) {
                      // console.error(`[DEBUG_LOG] ERROR: No item elements found for form data section ${section.type}`);
                      // console.log(`[DEBUG_LOG] Form data items container HTML:`, itemsContainer.outerHTML);
                    }

                    if (section.items.length > itemElements.length) {
                      // console.warn(`[DEBUG_LOG] WARNING: Form data section has ${section.items.length} items but only ${itemElements.length} item elements were found`);
                    }

                    section.items.forEach((item, itemIndex) => {
                      // console.log(`[DEBUG_LOG] Processing form data section ${section.type}, Item ${itemIndex}:`, JSON.stringify(item));

                      if (itemIndex < itemElements.length) {
                        const itemElement = itemElements[itemIndex];
                        // console.log(`[DEBUG_LOG] Found form data item element for ${section.type}, Item ${itemIndex}:`, itemElement);

                        // Populate all inputs and textareas in this item
                        const inputs = itemElement.querySelectorAll('input:not([type="hidden"]), textarea');
                        // console.log(`[DEBUG_LOG] Found ${inputs.length} inputs/textareas for form data ${section.type}, Item ${itemIndex}`);

                        if (inputs.length === 0) {
                          // console.error(`[DEBUG_LOG] ERROR: No input elements found for form data section ${section.type}, item ${itemIndex}`);
                          // console.log(`[DEBUG_LOG] Form data item element HTML:`, itemElement.outerHTML);
                        }

                        inputs.forEach(input => {
                          const name = input.getAttribute('name');
                          // console.log(`[DEBUG_LOG] Processing form data input: name=${name}, type=${input.type}, tagName=${input.tagName}`);

                          if (!name) {
                            // console.warn(`[DEBUG_LOG] WARNING: Form data input has no name attribute:`, input);
                            return;
                          }

                          try {
                            const fieldName = name.split(']').pop().replace('[', '').replace(']', '');
                            // console.log(`[DEBUG_LOG] Extracted form data field name: ${fieldName}, value in item: ${JSON.stringify(item[fieldName])}`);

                            if (item[fieldName] !== undefined) {
                              // console.log(`[DEBUG_LOG] Setting form data value for field ${fieldName} to ${JSON.stringify(item[fieldName])}`);

                              if (input.tagName === 'TEXTAREA') {
                                // console.log(`[DEBUG_LOG] Setting form data textarea value using multiple methods`);
                                // Try multiple approaches to set textarea value
                                // console.log(`[DEBUG_LOG] Before setting form data: defaultValue=${input.defaultValue}, value=${input.value}, innerHTML=${input.innerHTML}`);

                                input.defaultValue = item[fieldName];
                                // console.log(`[DEBUG_LOG] After setting form data defaultValue: ${input.defaultValue}`);

                                input.value = item[fieldName];
                                // console.log(`[DEBUG_LOG] After setting form data value: ${input.value}`);

                                input.innerHTML = item[fieldName];
                                // console.log(`[DEBUG_LOG] After setting form data innerHTML: ${input.innerHTML}`);

                                input.innerText = item[fieldName];
                                // console.log(`[DEBUG_LOG] After setting form data innerText: ${input.innerText}`);

                                // Force a change event to ensure the value is set
                                const event = new Event('change', { bubbles: true });
                                input.dispatchEvent(event);
                                // console.log(`[DEBUG_LOG] Dispatched form data change event`);

                                // Final check
                                // console.log(`[DEBUG_LOG] Final form data textarea state: defaultValue=${input.defaultValue}, value=${input.value}, innerHTML=${input.innerHTML}`);
                              } else {
                                // console.log(`[DEBUG_LOG] Setting form data regular input value: ${item[fieldName]}`);
                                input.value = item[fieldName];
                                // console.log(`[DEBUG_LOG] After setting, form data input value is: ${input.value}`);
                              }

                              // Verify the value was set correctly
                              if (input.value !== item[fieldName] && 
                                  !(Array.isArray(item[fieldName])) && 
                                  !(fieldName.includes('Date'))) {
                                // console.warn(`[DEBUG_LOG] WARNING: Form data value mismatch after setting. Expected: ${item[fieldName]}, Actual: ${input.value}`);
                              }
                            } else {
                              // console.log(`[DEBUG_LOG] Form data field ${fieldName} not found in item data`);
                            }
                          } catch (error) {
                            // console.error(`[DEBUG_LOG] ERROR processing form data field: ${error.message}`, error);
                          }
                        });
                      } else {
                        // console.error(`[DEBUG_LOG] ERROR: Form data item index ${itemIndex} is out of bounds (only ${itemElements.length} elements available)`);
                      }
                    });
                  }, 100); // 100ms delay
                }

                // If this is a custom section, initialize the Quill editor with the content
                if (section.type === 'custom' && section.items && section.items[0] && section.items[0].content) {
                  const editorId = `editor-${sectionIndex - 1}`;
                  const contentId = `content-${sectionIndex - 1}`;

                  setTimeout(() => {
                    const contentInput = document.getElementById(contentId);
                    if (contentInput) {
                      contentInput.value = section.items[0].content;

                      // Don't initialize Quill editor here
                      // The Quill editor will be initialized by the addSection function
                      const editorIndex = sectionIndex - 1;

                      // Set the content after ensuring the editor is initialized
                      if (quillEditors[editorIndex]) {
                        // Use clipboard.dangerouslyPasteHTML directly with the content
                        // No need for temporary div which causes HTML tags to be displayed as text
                        quillEditors[editorIndex].clipboard.dangerouslyPasteHTML(0, section.items[0].content);
                      } else {
                        console.log(`[DEBUG_LOG] Quill editor not found for editor index ${editorIndex}, trying again in 500ms`);
                        // Try again after a longer delay if the editor is not initialized yet
                        setTimeout(() => {
                          if (quillEditors[editorIndex]) {
                            // Use content directly without temporary div
                            quillEditors[editorIndex].clipboard.dangerouslyPasteHTML(0, section.items[0].content);
                            console.log(`[DEBUG_LOG] Successfully set content for editor index ${editorIndex} on second attempt`);
                          } else {
                            console.error(`[DEBUG_LOG] ERROR: Quill editor still not found for editor index ${editorIndex} after second attempt, trying one more time`);
                            // Try one more time with an even longer delay
                            setTimeout(() => {
                              if (quillEditors[editorIndex]) {
                                // Use content directly without temporary div
                                quillEditors[editorIndex].clipboard.dangerouslyPasteHTML(0, section.items[0].content);
                                console.log(`[DEBUG_LOG] Successfully set content for editor index ${editorIndex} on third attempt`);
                              } else {
                                console.error(`[DEBUG_LOG] ERROR: Quill editor still not found for editor index ${editorIndex} after third attempt. Giving up.`);
                              }
                            }, 1000);
                          }
                        }, 500);
                      }
                    }
                  }, 500); // Increased delay to ensure editor is initialized
                }
              }
            });
          }
        } catch (e) {
          // console.error("Error parsing form data:", e);
        }
      }
    }
  };

  function addSection(type) {
    // console.log(`[DEBUG_LOG] Adding section of type: ${type}, section index: ${sectionIndex}`);
    const container = document.getElementById('sections-container');
    if (!container) {
      // console.error(`[DEBUG_LOG] ERROR: sections-container not found!`);
      return;
    }
    // console.log(`[DEBUG_LOG] Found sections container:`, container);

    const template = document.getElementById(`${type}-template`);
    // console.log(`[DEBUG_LOG] Template for ${type}:`, template);

    if (!template) {
      // console.error(`[DEBUG_LOG] ERROR: Template not found for type: ${type}`);
      return;
    }

    // Declare div outside the try block so it's available throughout the function
    let div;

    try {
      // console.log(`[DEBUG_LOG] Cloning template for ${type}...`);
      const clone = document.importNode(template.content, true);
      // console.log(`[DEBUG_LOG] Successfully cloned template content:`, clone);

      // Create a temporary div to hold the cloned content
      const tempDiv = document.createElement('div');
      tempDiv.appendChild(clone);
      // console.log(`[DEBUG_LOG] Added clone to temporary div`);

      // Replace {index} placeholders with actual index
      // console.log(`[DEBUG_LOG] Replacing {index} placeholders with ${sectionIndex}`);
      const html = tempDiv.innerHTML.replace(/{index}/g, sectionIndex);

      div = document.createElement('div');
      div.innerHTML = html;
      div.id = `section-${sectionIndex}`;
      div.dataset.type = type;
      div.dataset.sectionIndex = sectionIndex;
      // console.log(`[DEBUG_LOG] Created section div with id: ${div.id}, type: ${div.dataset.type}`);

      // console.log(`[DEBUG_LOG] Adding section to container. Container children before: ${container.children.length}`);
      container.appendChild(div);
      // console.log(`[DEBUG_LOG] Section added. Container children after: ${container.children.length}`);

      // Verify the section was added correctly
      const addedSection = document.getElementById(`section-${sectionIndex}`);
      if (addedSection) {
        // console.log(`[DEBUG_LOG] Section was successfully added to DOM with id: ${addedSection.id}`);
      } else {
        // console.error(`[DEBUG_LOG] ERROR: Section was not found in DOM after adding!`);
      }
    } catch (error) {
      // console.error(`[DEBUG_LOG] ERROR in addSection: ${error.message}`, error);
      return; // Exit the function if an error occurs
    }

    // Only proceed if div was successfully created
    if (!div) {
      // console.error(`[DEBUG_LOG] ERROR: div was not created successfully`);
      return;
    }

    // Fix the onclick attribute of the "Add Another Entry" button
    const addEntryBtn = div.querySelector('.add-entry-btn');
    if (addEntryBtn) {
      addEntryBtn.setAttribute('onclick', `addEntry('section-${sectionIndex}')`);
    }

    // Initialize delete buttons visibility
    // Since each section starts with only one item, the delete button should be hidden initially
    const deleteButtons = div.querySelectorAll('.delete-item');
    deleteButtons.forEach(button => {
      button.style.display = 'none';
    });

    // Check if multi-page layout is enabled and show page selector if it is
    const multiPageCheckbox = document.getElementById('multiPageLayout');
    if (multiPageCheckbox && multiPageCheckbox.checked) {
      const pageSelector = div.querySelector('.page-selector');
      if (pageSelector) {
        pageSelector.style.display = 'block';
        // Update page selectors to populate with current page names
        updatePageSelectors();
      }
    }

    // Initialize Quill editor for custom sections
    if (type === 'custom') {
      const editorId = `editor-${sectionIndex}`;
      const contentId = `content-${sectionIndex}`;

      setTimeout(() => {
        const editorElement = document.getElementById(editorId);
        // First check if we already have a Quill instance for this editor in our array
        if (!quillEditors[sectionIndex]) {
          // Then check if the element already has a Quill instance attached to it
          if (editorElement && !editorElement.querySelector('.ql-toolbar')) {
            const quill = new Quill(`#${editorId}`, {
              theme: 'snow',
              modules: {
                toolbar: [
                  ['bold', 'italic', 'underline', 'strike'],
                  ['blockquote', 'code-block'],
                  [{ 'header': 1 }, { 'header': 2 }],
                  [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                  [{ 'script': 'sub' }, { 'script': 'super' }],
                  [{ 'indent': '-1' }, { 'indent': '+1' }],
                  ['clean']
                ]
              }
            });

            quill.on('text-change', function() {
              document.getElementById(contentId).value = quill.root.innerHTML;
            });

            // Store the Quill instance at the specific index instead of pushing it
            quillEditors[sectionIndex] = quill;

            // If there's initial content in the hidden input, render it properly
            const contentInput = document.getElementById(contentId);
            if (contentInput && contentInput.value) {
              // Use clipboard.dangerouslyPasteHTML to properly render HTML content
              // Create a temporary div to decode HTML entities
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = contentInput.value;
              quill.clipboard.dangerouslyPasteHTML(0, tempDiv.innerHTML);
            }
          }
        } else if (quillEditors[sectionIndex]) {
          // If we already have a Quill instance, make sure the content is properly rendered
          const contentInput = document.getElementById(contentId);
          if (contentInput && contentInput.value) {
            // Use clipboard.dangerouslyPasteHTML to properly render HTML content
            // Create a temporary div to decode HTML entities
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = contentInput.value;
            quillEditors[sectionIndex].clipboard.dangerouslyPasteHTML(0, tempDiv.innerHTML);
          }
        }
      }, 500); // Increased delay to ensure DOM is fully ready
    }

    sectionIndex++;
  }

  // Function to add a new entry to an existing section
  function addEntry(sectionId) {
    // console.log(`[DEBUG_LOG] Adding entry to section: ${sectionId}`);
    const sectionDiv = document.getElementById(sectionId);
    if (!sectionDiv) {
      // console.error(`[DEBUG_LOG] ERROR: Section div not found with id: ${sectionId}`);
      return;
    }

    const type = sectionDiv.dataset.type;
    const sectionIndex = sectionDiv.dataset.sectionIndex;
    // console.log(`[DEBUG_LOG] Section type: ${type}, index: ${sectionIndex}`);

    // Don't allow adding entries to custom sections
    if (type === 'custom') {
      // console.log(`[DEBUG_LOG] Not adding entry to custom section`);
      return;
    }

    try {
      // Find the items container
      const itemsContainer = sectionDiv.querySelector('.section-items');
      if (!itemsContainer) {
        // console.error(`[DEBUG_LOG] ERROR: Items container not found in section: ${sectionId}`);
        // console.log(`[DEBUG_LOG] Section div HTML:`, sectionDiv.outerHTML);
        return;
      }
      // console.log(`[DEBUG_LOG] Found items container:`, itemsContainer);

      // Get the current number of items
      const itemElements = itemsContainer.querySelectorAll('.section-item');
      const itemCount = itemElements.length;
      // console.log(`[DEBUG_LOG] Current item count: ${itemCount}`);

      if (itemCount > 0) {
        // console.log(`[DEBUG_LOG] Last item element:`, itemElements[itemCount - 1]);
      }

      // Create a new item based on the section type
      const template = document.getElementById(`${type}-item-template`);
      // console.log(`[DEBUG_LOG] Template for ${type} item:`, template);

      if (!template) {
        // console.error(`[DEBUG_LOG] ERROR: Template not found for type: ${type}-item-template`);
        return;
      }

      // console.log(`[DEBUG_LOG] Cloning template for ${type} item...`);
      const clone = document.importNode(template.content, true);
      // console.log(`[DEBUG_LOG] Successfully cloned template content:`, clone);

      // Create a temporary div to hold the cloned content
      const tempDiv = document.createElement('div');
      tempDiv.appendChild(clone);
      // console.log(`[DEBUG_LOG] Added clone to temporary div`);

      // Replace {index} and {itemIndex} placeholders
      // console.log(`[DEBUG_LOG] Replacing {index} with ${sectionIndex} and {itemIndex} with ${itemCount}`);
      const html = tempDiv.innerHTML
        .replace(/{index}/g, sectionIndex)
        .replace(/{itemIndex}/g, itemCount);

      // console.log(`[DEBUG_LOG] HTML after replacement:`, html.substring(0, 100) + '...');

      // Append the HTML directly to the items container
      const tempContainer = document.createElement('div');
      tempContainer.innerHTML = html;
      // console.log(`[DEBUG_LOG] Created temp container with HTML`);

      // Make sure we're appending the section-item element
      const sectionItem = tempContainer.querySelector('.section-item');
      if (sectionItem) {
        // console.log(`[DEBUG_LOG] Found section-item element in temp container:`, sectionItem);
        // console.log(`[DEBUG_LOG] Appending section item to items container. Container children before: ${itemsContainer.children.length}`);
        itemsContainer.appendChild(sectionItem);
        // console.log(`[DEBUG_LOG] Section item appended. Container children after: ${itemsContainer.children.length}`);

        // Verify the item was added correctly
        const newItemElements = itemsContainer.querySelectorAll('.section-item');
        if (newItemElements.length > itemCount) {
          // console.log(`[DEBUG_LOG] Item was successfully added. New count: ${newItemElements.length}`);
          // console.log(`[DEBUG_LOG] New item:`, newItemElements[newItemElements.length - 1]);
        } else {
          // console.error(`[DEBUG_LOG] ERROR: Item was not added correctly. Expected count: ${itemCount + 1}, Actual: ${newItemElements.length}`);
        }
      } else {
        // Fallback: append the first child if section-item not found
        // console.warn(`[DEBUG_LOG] WARNING: Section item not found in temp container, using fallback`);
        // console.log(`[DEBUG_LOG] Temp container HTML:`, tempContainer.innerHTML);
        // console.log(`[DEBUG_LOG] Appending first child:`, tempContainer.firstChild);
        itemsContainer.appendChild(tempContainer.firstChild);

        // Verify the item was added correctly
        const newItemElements = itemsContainer.querySelectorAll('.section-item');
        if (newItemElements.length > itemCount) {
          // console.log(`[DEBUG_LOG] Item was successfully added using fallback. New count: ${newItemElements.length}`);
        } else {
          // console.error(`[DEBUG_LOG] ERROR: Item was not added correctly using fallback. Expected count: ${itemCount + 1}, Actual: ${newItemElements.length}`);
        }
      }

      // Update delete buttons visibility
      updateDeleteButtonsVisibility(sectionDiv);

      // console.log('[DEBUG_LOG] New entry added successfully');
    } catch (error) {
      // console.error(`[DEBUG_LOG] ERROR in addEntry: ${error.message}`, error);
    }
  }

  // Function to delete a section
  function deleteSection(sectionId) {
    const sectionDiv = document.getElementById(sectionId);
    if (sectionDiv) {
      sectionDiv.remove();
    }
  }

  // Function to delete an item
  function deleteItem(button) {
    const sectionItem = button.closest('.section-item');
    const sectionDiv = sectionItem.closest('[id^="section-"]');

    if (sectionItem && sectionDiv) {
      sectionItem.remove();

      // Update delete buttons visibility
      updateDeleteButtonsVisibility(sectionDiv);

      // Renumber the remaining items to ensure proper form submission
      renumberItems(sectionDiv);
    }
  }

  // Function to update delete buttons visibility
  function updateDeleteButtonsVisibility(sectionDiv) {
    const itemsContainer = sectionDiv.querySelector('.section-items');
    const items = itemsContainer.querySelectorAll('.section-item');

    // Show delete buttons only if there are 2 or more items
    items.forEach(item => {
      const deleteButton = item.querySelector('.delete-item');
      if (deleteButton) {
        deleteButton.style.display = items.length >= 2 ? 'block' : 'none';
      }
    });
  }

  // Function to renumber items after deletion or reordering
  function renumberItems(sectionDiv) {
    const type = sectionDiv.dataset.type;
    const sectionIndex = sectionDiv.dataset.sectionIndex;
    const itemsContainer = sectionDiv.querySelector('.section-items');
    const items = itemsContainer.querySelectorAll('.section-item');

    items.forEach((item, index) => {
      // Update all input and textarea names
      const inputs = item.querySelectorAll('input, textarea');
      inputs.forEach(input => {
        const name = input.getAttribute('name');
        if (name) {
          const newName = name.replace(/sections\[\d+\]\[items\]\[\d+\]/, `sections[${sectionIndex}][items][${index}]`);
          input.setAttribute('name', newName);
        }
      });

      // Add order field if it doesn't exist
      let orderInput = item.querySelector('input[name$="[order]"]');
      if (!orderInput) {
        orderInput = document.createElement('input');
        orderInput.type = 'hidden';
        orderInput.name = `sections[${sectionIndex}][items][${index}][order]`;
        item.appendChild(orderInput);
      } else {
        orderInput.name = `sections[${sectionIndex}][items][${index}][order]`;
      }
      orderInput.value = index;
    });
  }

  // Function to move a section up or down
  function moveSection(sectionId, direction) {
    const sectionDiv = document.getElementById(sectionId);
    const container = document.getElementById('sections-container');
    const sections = Array.from(container.children);
    const currentIndex = sections.indexOf(sectionDiv);

    if (direction === 'up' && currentIndex > 0) {
      // Move section up
      container.insertBefore(sectionDiv, sections[currentIndex - 1]);
    } else if (direction === 'down' && currentIndex < sections.length - 1) {
      // Move section down
      container.insertBefore(sections[currentIndex + 1], sectionDiv);
    }

    // Update section order values
    sections.forEach((section, index) => {
      let orderInput = section.querySelector('input[name$="[order]"]');
      if (!orderInput) {
        orderInput = document.createElement('input');
        orderInput.type = 'hidden';
        orderInput.name = `sections[${section.dataset.sectionIndex}][order]`;
        section.appendChild(orderInput);
      }
      orderInput.value = index;
    });
  }

  // Function to move an item up or down
  function moveItem(button, direction) {
    const itemDiv = button.closest('.section-item');
    const sectionDiv = itemDiv.closest('[id^="section-"]');
    const itemsContainer = sectionDiv.querySelector('.section-items');
    const items = Array.from(itemsContainer.querySelectorAll('.section-item'));
    const currentIndex = items.indexOf(itemDiv);

    if (direction === 'up' && currentIndex > 0) {
      // Move item up
      itemsContainer.insertBefore(itemDiv, items[currentIndex - 1]);
    } else if (direction === 'down' && currentIndex < items.length - 1) {
      // Move item down
      itemsContainer.insertBefore(items[currentIndex + 1], itemDiv);
    }

    // Renumber items to ensure proper form submission
    renumberItems(sectionDiv);

    // Update delete buttons visibility
    updateDeleteButtonsVisibility(sectionDiv);
  }

  // Toggle page names section based on multi-page layout checkbox
  function togglePageNamesSection() {
    const multiPageCheckbox = document.getElementById('multiPageLayout');
    const pageNamesSection = document.getElementById('pageNamesSection');
    const pageSelectorDivs = document.querySelectorAll('.page-selector');

    if (multiPageCheckbox.checked) {
      pageNamesSection.style.display = 'block';
      pageSelectorDivs.forEach(div => {
        div.style.display = 'block';
      });
    } else {
      pageNamesSection.style.display = 'none';
      pageSelectorDivs.forEach(div => {
        div.style.display = 'none';
      });
    }
  }

  // Initialize page names section on page load
  window.addEventListener('DOMContentLoaded', function() {
    togglePageNamesSection();
  });

  // Add a new page name input
  let pageNameIndex = 1; // Start at 1 because we already have page 0 (Home)
  function addPageName() {
    if (pageNameIndex >= 7) { // Max 8 pages (0-7)
      alert('Maximum of 8 pages allowed');
      return;
    }

    const container = document.getElementById('pageNames-container');
    const div = document.createElement('div');
    div.className = 'form-group';
    div.innerHTML = `
      <div class="page-name-container">
        <label for="pageName${pageNameIndex}">Page ${pageNameIndex + 1}:<span>*</span></label>
        <input type="text" id="pageName${pageNameIndex}" name="pageNames[${pageNameIndex}]" required>
        <button type="button" class="btn-delete delete-page" onclick="deletePage(this)">Delete</button>
      </div>
    `;
    container.appendChild(div);

    // Add event listener to the new input field to update page selectors when the value changes
    const newInput = document.getElementById(`pageName${pageNameIndex}`);
    newInput.addEventListener('input', updatePageSelectors);

    // Update page selectors in all sections
    updatePageSelectors();

    pageNameIndex++;

    // Disable add button if max reached
    if (pageNameIndex >= 8) {
      document.getElementById('addPageBtn').disabled = true;
    }
  }

  // Delete a page name input
  function deletePage(button) {
    const pageContainer = button.closest('.form-group');
    pageContainer.remove();
    pageNameIndex--;

    // Re-enable add button if below max
    if (pageNameIndex < 8) {
      document.getElementById('addPageBtn').disabled = false;
    }

    // Renumber the remaining pages
    const pageLabels = document.querySelectorAll('#pageNames-container label');
    const pageInputs = document.querySelectorAll('#pageNames-container input');

    pageLabels.forEach((label, index) => {
      label.setAttribute('for', `pageName${index}`);
      label.textContent = `Page ${index + 1}:`;
    });

    pageInputs.forEach((input, index) => {
      input.id = `pageName${index}`;
      input.name = `pageNames[${index}]`;
    });

    // Update page selectors in all sections
    updatePageSelectors();
  }

  // Update page selectors in all sections
  function updatePageSelectors() {
    const pageInputs = document.querySelectorAll('#pageNames-container input');
    const pageSelectors = document.querySelectorAll('.page-selector select');

    pageSelectors.forEach(selector => {
      // Save current selection if any
      const currentSelection = selector.value;

      // Clear all options
      while (selector.options.length > 0) {
        selector.remove(0);
      }

      // Add options for each page
      pageInputs.forEach((input, index) => {
        const pageName = input.value || `Page ${index + 1}`;
        const option = document.createElement('option');
        option.value = index;
        option.textContent = pageName;
        selector.appendChild(option);
      });

      // Restore selection if it still exists, otherwise set to first page (Page 1)
      if (currentSelection && selector.querySelector(`option[value="${currentSelection}"]`)) {
        selector.value = currentSelection;
      } else if (selector.options.length > 0) {
        selector.value = 0; // Set to first page (Page 1)
      }
    });
  }

  // Handle form submission
  document.querySelector('.portfolio-form').addEventListener('submit', function(e) {
    // Make sure all Quill editor content is saved to hidden inputs
    quillEditors.forEach((quill, index) => {
      const contentId = `content-${index}`;
      document.getElementById(contentId).value = quill.root.innerHTML;
    });

    // Process achievements (convert textarea to array)
    const achievementsTextareas = document.querySelectorAll('textarea[name*="achievements"]');
    achievementsTextareas.forEach(textarea => {
      const lines = textarea.value.split('\n').filter(line => line.trim() !== '');
      textarea.value = JSON.stringify(lines);
    });

    // Process technologies (convert comma-separated string to array)
    const technologiesInputs = document.querySelectorAll('input[name*="technologies"]');
    technologiesInputs.forEach(input => {
      const techs = input.value.split(',').map(tech => tech.trim()).filter(tech => tech !== '');
      input.value = JSON.stringify(techs);
    });

    // Process page names for multi-page layout
    const multiPageCheckbox = document.getElementById('multiPageLayout');
    if (multiPageCheckbox.checked) {
      const pageInputs = document.querySelectorAll('#pageNames-container input');
      const pageNames = Array.from(pageInputs).map(input => input.value);

      // Create hidden input for layout
      const layoutInput = document.createElement('input');
      layoutInput.type = 'hidden';
      layoutInput.name = 'layout[singlePage]';
      layoutInput.value = 'false';
      this.appendChild(layoutInput);

      // Create hidden input for pages
      pageNames.forEach((name, index) => {
        const pageInput = document.createElement('input');
        pageInput.type = 'hidden';
        pageInput.name = `layout[pages][${index}][title]`;
        pageInput.value = name;
        this.appendChild(pageInput);
      });

      // Process page selections for each section
      const sections = document.querySelectorAll('[id^="section-"]');
      sections.forEach(section => {
        const sectionIndex = section.dataset.sectionIndex;
        const pageSelector = section.querySelector('.page-selector select');
        if (pageSelector) {
          const selectedPage = pageSelector.value;

          if (selectedPage === 'all') {
            // If "All Pages" is selected, add this section to all pages
            pageNames.forEach((name, pageIndex) => {
              const sectionPageInput = document.createElement('input');
              sectionPageInput.type = 'hidden';
              sectionPageInput.name = `layout[pages][${pageIndex}][sectionIds][]`;
              // Use the actual section ID from the database if available, otherwise use the element ID
              sectionPageInput.value = section.dataset.sectionId || `section-${sectionIndex}`;
              this.appendChild(sectionPageInput);
            });
          } else {
            // Add this section to the selected page
            const sectionPageInput = document.createElement('input');
            sectionPageInput.type = 'hidden';
            sectionPageInput.name = `layout[pages][${selectedPage}][sectionIds][]`;
            // Use the actual section ID from the database if available, otherwise use the element ID
            sectionPageInput.value = section.dataset.sectionId || `section-${sectionIndex}`;
            this.appendChild(sectionPageInput);
          }
        }
      });
    } else {
      // Create hidden input for single page layout
      const layoutInput = document.createElement('input');
      layoutInput.type = 'hidden';
      layoutInput.name = 'layout[singlePage]';
      layoutInput.value = 'true';
      this.appendChild(layoutInput);
    }

    // Ensure all sections have order fields and section IDs
    const sections = document.querySelectorAll('[id^="section-"]');
    sections.forEach((section, index) => {
      // Add order field
      let orderInput = section.querySelector('input[name$="[order]"]');
      if (!orderInput) {
        orderInput = document.createElement('input');
        orderInput.type = 'hidden';
        orderInput.name = `sections[${section.dataset.sectionIndex}][order]`;
        section.appendChild(orderInput);
      }
      orderInput.value = index;

      // Add section ID field if available
      if (section.dataset.sectionId) {
        let idInput = section.querySelector('input[name$="[_id]"]');
        if (!idInput) {
          idInput = document.createElement('input');
          idInput.type = 'hidden';
          idInput.name = `sections[${section.dataset.sectionIndex}][_id]`;
          section.appendChild(idInput);
        }
        idInput.value = section.dataset.sectionId;
      }

      // Ensure all items in this section have order fields and item IDs
      const itemsContainer = section.querySelector('.section-items');
      if (itemsContainer) {
        const items = itemsContainer.querySelectorAll('.section-item');
        items.forEach((item, itemIndex) => {
          // Add order field
          let itemOrderInput = item.querySelector('input[name$="[order]"]');
          if (!itemOrderInput) {
            itemOrderInput = document.createElement('input');
            itemOrderInput.type = 'hidden';
            itemOrderInput.name = `sections[${section.dataset.sectionIndex}][items][${itemIndex}][order]`;
            item.appendChild(itemOrderInput);
          }
          itemOrderInput.value = itemIndex;

          // Add item ID field if available
          if (item.dataset.itemId) {
            let itemIdInput = item.querySelector('input[name$="[_id]"]');
            if (!itemIdInput) {
              itemIdInput = document.createElement('input');
              itemIdInput.type = 'hidden';
              itemIdInput.name = `sections[${section.dataset.sectionIndex}][items][${itemIndex}][_id]`;
              item.appendChild(itemIdInput);
            }
            itemIdInput.value = item.dataset.itemId;
          }
        });
      }
    });
  });
</script>
